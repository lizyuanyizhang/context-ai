# 生词本功能测试指南

## 前置准备

### 1. 安装依赖

```bash
npm install
```

### 2. 配置 API Key

确保 `.env` 文件中已配置通义千问 API Key：

```bash
VITE_QWEN_API_KEY=your_api_key_here
```

### 3. 构建项目

```bash
npm run build
```

构建完成后，`dist` 目录就是可以加载到 Chrome 的插件包。

### 4. 加载插件到 Chrome

1. 打开 Chrome，访问 `chrome://extensions/`
2. 开启"开发者模式"（右上角开关）
3. 点击"加载已解压的扩展程序"
4. 选择项目的 `dist` 目录

## 测试步骤

### 测试 1: 保存单词到生词本

**步骤**：
1. 打开任意网页（如英文新闻网站）
2. 选中一段英文文字（2-500 个字符）
3. 点击出现的"翻译"按钮
4. 等待翻译完成
5. 点击"保存到生词本"按钮
6. 观察是否显示"✅ 已保存到生词本！"提示

**预期结果**：
- ✅ 翻译面板显示翻译结果
- ✅ 保存按钮点击后显示成功提示
- ✅ 按钮文字变为"✅ 已保存"

**验证方法**：
- 打开浏览器控制台（F12），查看是否有错误
- 检查 `chrome.storage.local` 中是否有数据：
  - 打开 `chrome://extensions/`
  - 找到插件，点击"检查视图" → "Service Worker"
  - 在控制台输入：`chrome.storage.local.get(null, console.log)`

### 测试 2: 查看生词本

**步骤**：
1. 点击浮动按钮旁边的"生词本"按钮（选中文字时）
2. 或点击右下角的"生词本"图标（未选中文字时）
3. 观察生词本面板是否正常打开

**预期结果**：
- ✅ 生词本面板正常打开
- ✅ 显示之前保存的单词列表
- ✅ 每个单词显示：原始文本、翻译、语法、上下文、创建时间、查看次数

**验证方法**：
- 检查单词列表是否正确显示
- 检查单词信息是否完整

### 测试 3: 搜索单词

**步骤**：
1. 打开生词本面板
2. 在搜索框中输入关键词（如原始文本或翻译）
3. 观察搜索结果

**预期结果**：
- ✅ 实时搜索，输入时立即显示结果
- ✅ 搜索匹配原始文本、翻译、语法、上下文
- ✅ 搜索为空时显示所有单词

**测试用例**：
- 搜索原始文本："hello"
- 搜索翻译："你好"
- 搜索不存在的词："xyz123"
- 清空搜索框，应该显示所有单词

### 测试 4: 删除单词

#### 4.1 单个删除

**步骤**：
1. 打开生词本面板
2. 找到要删除的单词
3. 点击单词卡片右上角的删除按钮（垃圾桶图标）
4. 确认删除对话框，点击"确定"

**预期结果**：
- ✅ 显示确认对话框
- ✅ 确认后单词从列表中消失
- ✅ 数据从存储中删除

#### 4.2 批量删除

**步骤**：
1. 打开生词本面板
2. 勾选多个单词的复选框
3. 点击"删除选中 (N)"按钮
4. 确认删除对话框，点击"确定"

**预期结果**：
- ✅ 可以勾选多个单词
- ✅ 显示选中数量
- ✅ 批量删除后，选中的单词全部消失

**测试用例**：
- 选择 1 个单词删除
- 选择多个单词删除
- 使用"全选"功能删除所有单词

### 测试 5: 导出数据

#### 5.1 导出为 JSON

**步骤**：
1. 打开生词本面板
2. 确保有至少一个单词
3. 点击"导出 JSON"按钮
4. 检查下载的文件

**预期结果**：
- ✅ 自动下载 JSON 文件
- ✅ 文件名格式：`生词本_YYYY-MM-DD.json`
- ✅ 文件内容包含所有单词的完整数据

**验证方法**：
- 打开下载的 JSON 文件
- 检查数据结构是否正确
- 检查数据是否完整

#### 5.2 导出为 CSV

**步骤**：
1. 打开生词本面板
2. 确保有至少一个单词
3. 点击"导出 CSV"按钮
4. 检查下载的文件

**预期结果**：
- ✅ 自动下载 CSV 文件
- ✅ 文件名格式：`生词本_YYYY-MM-DD.csv`
- ✅ 可以用 Excel 打开
- ✅ 包含表头和数据行

**验证方法**：
- 用 Excel 打开 CSV 文件
- 检查列是否正确：原始文本、翻译、语法、上下文、音标、创建时间、查看次数
- 检查数据是否正确

### 测试 6: 重复保存

**步骤**：
1. 保存一个单词到生词本
2. 再次翻译相同的文字
3. 再次点击"保存到生词本"

**预期结果**：
- ✅ 不创建新条目
- ✅ 更新查看时间和查看次数
- ✅ 更新翻译结果（如果重新翻译了）

**验证方法**：
- 检查生词本中只有一个条目
- 检查查看次数是否增加
- 检查最后查看时间是否更新

### 测试 7: 边界情况

#### 7.1 空生词本

**步骤**：
1. 清空所有单词（或使用新安装的插件）
2. 打开生词本面板

**预期结果**：
- ✅ 显示空状态提示
- ✅ 显示"生词本为空"消息
- ✅ 提示用户如何添加单词

#### 7.2 大量数据

**步骤**：
1. 保存大量单词（50+ 个）
2. 打开生词本面板
3. 滚动查看列表

**预期结果**：
- ✅ 列表正常显示
- ✅ 滚动流畅
- ✅ 搜索功能正常

#### 7.3 特殊字符

**步骤**：
1. 翻译包含特殊字符的文字（如：`"Hello, world!"`）
2. 保存到生词本
3. 导出为 CSV

**预期结果**：
- ✅ 特殊字符正确保存
- ✅ CSV 导出时正确转义（用引号包裹）

## 调试技巧

### 1. 查看存储数据

在 Background Script 控制台（Service Worker）：

```javascript
// 获取所有存储数据
chrome.storage.local.get(null, (data) => {
  console.log('所有数据：', data)
})

// 获取生词本数据
chrome.storage.local.get(['context_ai_wordbook'], (data) => {
  console.log('生词本数据：', data.context_ai_wordbook)
})
```

### 2. 清空存储数据

```javascript
// 清空所有数据（谨慎使用！）
chrome.storage.local.clear(() => {
  console.log('已清空所有数据')
})

// 只清空生词本
chrome.storage.local.remove(['context_ai_wordbook'], () => {
  console.log('已清空生词本')
})
```

### 3. 手动添加测试数据

```javascript
// 添加测试单词
chrome.storage.local.get(['context_ai_wordbook'], (data) => {
  const wordbook = data.context_ai_wordbook || {
    words: [],
    version: 1,
    createdAt: Date.now(),
    updatedAt: Date.now()
  }
  
  wordbook.words.push({
    id: 'test-' + Date.now(),
    originalText: 'Hello',
    translation: '你好',
    grammar: '问候语',
    context: '日常用语',
    createdAt: Date.now(),
    lastViewedAt: Date.now(),
    viewCount: 1
  })
  
  chrome.storage.local.set({ context_ai_wordbook: wordbook }, () => {
    console.log('测试数据已添加')
  })
})
```

### 4. 检查消息传递

在 Content Script 控制台：

```javascript
// 测试保存单词
chrome.runtime.sendMessage({
  type: 'SAVE_WORD',
  data: {
    originalText: 'Test',
    translation: '测试',
    grammar: '测试语法',
    context: '测试上下文'
  }
}, (response) => {
  console.log('保存响应：', response)
})

// 测试获取生词本
chrome.runtime.sendMessage({
  type: 'GET_WORDBOOK'
}, (response) => {
  console.log('生词本响应：', response)
})
```

## 常见问题排查

### 问题 1: 保存后没有显示成功提示

**可能原因**：
- `saveSuccess` 状态没有正确传递
- 保存操作失败但没有显示错误

**解决方法**：
1. 检查浏览器控制台是否有错误
2. 检查 Background Script 控制台
3. 验证消息传递是否正常

### 问题 2: 生词本面板打不开

**可能原因**：
- `showWordbook` 状态没有正确设置
- 组件渲染问题

**解决方法**：
1. 检查 `App.tsx` 中的状态管理
2. 检查 `WordbookPanel` 组件的 `isOpen` prop
3. 查看控制台错误信息

### 问题 3: 搜索不工作

**可能原因**：
- `searchWords` 函数没有正确调用
- 搜索逻辑有问题

**解决方法**：
1. 检查 `useWordbook` Hook 中的搜索逻辑
2. 检查消息传递是否正常
3. 验证搜索关键词是否正确传递

### 问题 4: 导出文件损坏

**可能原因**：
- CSV 转义有问题
- 编码问题

**解决方法**：
1. 检查 `escapeCSV` 函数
2. 检查 Blob 创建是否正确
3. 验证文件内容

## 性能测试

### 1. 大量数据测试

保存 100+ 个单词，测试：
- 列表渲染性能
- 搜索性能
- 导出性能

### 2. 频繁操作测试

快速连续操作：
- 保存多个单词
- 删除多个单词
- 搜索多次

观察是否有性能问题或 UI 卡顿。

## 测试检查清单

- [ ] 保存单词功能正常
- [ ] 查看生词本功能正常
- [ ] 搜索功能正常
- [ ] 单个删除功能正常
- [ ] 批量删除功能正常
- [ ] 导出 JSON 功能正常
- [ ] 导出 CSV 功能正常
- [ ] 重复保存处理正确
- [ ] 空状态显示正确
- [ ] 错误处理正确
- [ ] UI 响应流畅
- [ ] 数据持久化正常

## 测试报告模板

```
测试日期：YYYY-MM-DD
测试人员：XXX
Chrome 版本：XXX
插件版本：1.0.0

测试结果：
- 保存功能：✅/❌
- 查看功能：✅/❌
- 搜索功能：✅/❌
- 删除功能：✅/❌
- 导出功能：✅/❌

发现的问题：
1. ...
2. ...

建议：
1. ...
2. ...
```
